# Memcached Booster Profiling Documentation

Broadly, profiling of the memcached booster consists of timing
the delay between a sent memcached request and its response,
with and without the booster in-line.

## Set-up

### Machine topology

The test topology consists of:
* A switch
* The FPGA running the booster
* The server to program the bitsream to the fpga
  * the "Bitstream" server, johnshack
* A server running memcached
  * the "Memcached" server, tclust13 (10.0.0.3)
* A server running tcpdump/moongen
  * the "Tcpdump" server, tclust14
* A server running pktgen
  * the "DPDK" server, tclust4
* A server to coordinate experiments from
  * the "Coordination" server, tclust11

To ease the transition between booster/nonbooster experiments,
the origin IP address of packets loaded into pktgen
determines whether the packet will be served by the
booster or memcached alone.

In the following configuration, a source IP address of
`10.0.0.10` implies the packet is destined for
the booster, while a source IP of `10.0.0.20`
implies the packet is destined for memcached alone.

The switch, an Arista running directflow, is programmed
with the following configuration:

```
localhost(config-directflow)#show active
 directflow
   no shutdown
   flow dpdk-fpga
      match input interface Ethernet5/1
      match ethertype ip
      match source ip 10.0.0.10
      action output interface Ethernet4/1
      action output interface Ethernet7/1
   !
   flow dpdk-memcached
      match input interface Ethernet5/1
      match ethertype ip
      match source ip 10.0.0.20
      action output interface Ethernet3/1
      action output interface Ethernet4/1
   !
   flow fpga-memcached
      match input interface Ethernet7/1
      match ethertype ip
      match destination ip 10.0.0.3
      action output interface Ethernet3/1
   !
   flow fpga-tcpdump
      match input interface Ethernet7/1
      match ethertype ip
      match destination ip 10.0.0.10
      action output interface Ethernet4/1
   !
   flow memcached-fpga
      match input interface Ethernet3/1
      match ethertype ip
      match destination ip 10.0.0.10
      action output interface Ethernet7/1
   !
   flow memcached-tcpdump
      match input interface Ethernet3/1
      match ethertype ip
      match destination ip 10.0.0.20
      action output interface Ethernet4/1
```


### Dependencies

The following applications are necessary on these machines:

* Bitstream server:
  * Xilinx??
* Memcached server:
  * Memcached `[[ Installation instructions?? ]]`
* Tcpdump server:
  * Moongen [https://github.com/emmericp/MoonGen]
* DPDK server:
  * pktgen
    * Clone https://github.com/jsonch/dpdkScripts
    * Run dpdkScripts/installDpdk.sh (NO SUDO)
    * Run dpdkScripts/installPktgen.sh (NO SUDO)
    * Start dpdk-pktgen with dpdkScripts/runScripts/connectx3/pktGen.sh
    (You may want to copy and adjust this script)
* Coordination server:
  * Shremote [https://github.com/isaac-ped/Shremote]

### Configuration

The shremote configuration file `mcd_booster_moongen.yml`
assumes certain applications are in designated locations
and permissions are set accordingly.

Applications should be placed in the same directory,
or the config should be modified accordingly.

They are:

* `~/P4Boosters/FPGA/RSESDx/Run_project.bash`
  * Necessary on "Bistream" host
  * Should be configured to load the memcached bitstream to the FPGA
* `~/dcomp/moongen/MoonGen/
  * On "tcpdump" host
  * The directory into which MoonGen was cloned and built
  * **Ensure `build/MoonGen` has the suid bit set**
* `~/dcomp/dpdk/run_lua.sh`
  * On "DPDK" host
  * Assumes it is placed in the parent directory of dpdkScripts
  * **Ensure `dpdkScripts/dpdkInstall/pktgen-3.4.9/app/x86_64-native-linuxapp-gcc/pktgen`
    has the suid bit set**

### Necessary files

The following files are used by the testing coordination tool (shremote),
and should be placed in the directory from which shremote.py is run

* mcd_[no]booster_moongen.yml
  * defines the progression of the tests
* pktgen_template.lua
  * template lua script for pktgen, into which rate is inserted
* booster.pcap
  * The file replayed from pktgen to test the booster
  * Generated by capturing output of memaslap when testing memcached
    * Run `P4Boosters/generate_memaslap_packet.sh`, then
    * `python set_src_dst.py TX.pcap 00:02:c9:39:d6:d1 10.0.0.3 7c:fe:90:1c:36:80 10.0.0.10 booster.pcap` 
* nobooster.pcap
  * File replayed from pktgen to test memcached alone
  * Generated by capturing output of memaslap testing memcached
    * Run `P4Boosters/generate_memaslap_packet.sh`, then
    * `python set_src_dst.py TX.pcap 00:02:c9:39:d6:d1 10.0.0.3 7c:fe:90:1c:36:80 10.0.0.20 nobooster.pcap`

## Running

Start shremote with:
```
python shremote.py <cfg.yml> <label> --args="rate:<rate>" --out <output_dir>
```
Where cfg.yml is one of the `...booster_moongen.yml` files above, and rate
is the rate (in percent of total capacity) at which
traffic should be sent.

To run a full set of booster/nobooster experiments, run:
```
python repeat_moongen_shremote.py 1
python repeat_moongen_shremote_noboost.py 1
```
Where the trailing number is a label to be placed on the output file

Finally, to run the full set of experiments, run

```
bash run_both.sh
```

Which will run 3 sets of experiments at various rates for both booster
and non-booster.
